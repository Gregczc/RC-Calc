<!DOCTYPE html>
<html>

<!--
RC-Calc: An all-in-one R/C & FPV flying stuff calculator
Copyright (C) 2020 Grégoire CAHUZAC <gregoire.cahuzac@outlook.fr>
This file is part of RC-Calc. <https://github.com/Gregczc/RC-Calc>

RC-Calc is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or any later version.

RC-Calc is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with RC-Calc.  If not, see <http://www.gnu.org/licenses/>.
-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>RC-Calc</title>

    <meta property="og:title" content="RC-Calc"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="http://localhost:8888/"/>
    <meta property="og:image" content="/static/icons/rc-calc-512.png"/>
    <meta property="og:description" content="All the RC tools in one app!"/>

    <link rel="manifest" href="/static/json/manifest.json">

    <!-- Not sure if mandatory or if manifest.json is mis-configured -->
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/rc-calc-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/rc-calc-32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/static/icons/rc-calc-48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/icons/rc-calc-96.png">
    <link rel="icon" type="image/png" sizes="144x144" href="/static/icons/rc-calc-144.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/rc-calc-192.png">
    <link rel="icon" type="image/png" sizes="256x256" href="/static/icons/rc-calc-256.png">
    <link rel="icon" type="image/png" sizes="384x384" href="/static/icons/rc-calc-384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/rc-calc-512.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.css">

    <!-- Bootstrap Table CSS -->
    <link rel="stylesheet" href="/static/bootstrap-table/bootstrap-table.css">
    <link rel="stylesheet" href="/static/bootstrap-table/extensions/sticky-header/bootstrap-table-sticky-header.css">
    <link rel="stylesheet" href="/static/bootstrap-table/extensions/fixed-columns/bootstrap-table-fixed-columns.css">

    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="/static/css/style_main.css">
    <link rel="stylesheet" href="/static/css/style_cell_inventory.css">

    <!-- Font Awesome JS -->
    <script defer src="/static/fontawesome-free/js/all.js"></script>

</head>

<body>

    <div class="wrapper">

        <div data-include="sidebar"></div>

        <!-- Page Content  -->
        <div id="content">

            <!-- Navbar  -->
            <div data-include="navbar"></div>
            
            <div id="alertAjaxError" class="alert alert-danger fade show" role="alert" style="display:none;">
                <strong>Error!</strong> The server did not respond properly, please check the console for more information.
                <button type="button" class="close" aria-label="Close" onclick="dismiss_alert(this)">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div id="alertAlreadyExisting" class="alert alert-danger fade show" role="alert" style="display:none;">
                <strong>Error!</strong> A cell is already existing with the same name.
                <button type="button" class="close" aria-label="Close" onclick="dismiss_alert(this)">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div id="alertDatasheet" class="alert alert-danger fade show" role="alert" style="display:none;">
                <strong>Error!</strong> An error occurred with the datasheet thus was not added with the cell. Please check the console for more information.
                <button type="button" class="close" aria-label="Close" onclick="dismiss_alert(this)" style="display:none;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div id="alertSuccessAdded" class="alert alert-success fade show collapse" role="alert" style="display:none;">
                <strong>Success!</strong> The cell was correctly added.
                <button type="button" class="close" aria-label="Close" onclick="dismiss_alert(this)">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div id="alertSuccessDeleted" class="alert alert-success fade show collapse" role="alert" style="display:none;">
                <strong>Success!</strong> The cell was correctly deleted.
                <button type="button" class="close" aria-label="Close" onclick="dismiss_alert(this)">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div id="alertErrorDeleted" class="alert alert-danger fade show collapse" role="alert" style="display:none;">
                <strong>Error!</strong> The cell could not be deleted. Please check the console for more infos.
                <button type="button" class="close" aria-label="Close" onclick="dismiss_alert(this)">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div id="alertSuccessUpdated" class="alert alert-success fade show collapse" role="alert" style="display:none;">
                <strong>Success!</strong> The cell was correctly updated.
                <button type="button" class="close" aria-label="Close" onclick="dismiss_alert(this)">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div id="alertErrorUpdated" class="alert alert-danger fade show collapse" role="alert" style="display:none;">
                <strong>Error!</strong> The cell could not be updated. Please check the console for more infos.
                <button type="button" class="close" aria-label="Close" onclick="dismiss_alert(this)">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <h2>Cell Inventory</h2>
            <p>This page a to manage the cells available to build a pack in the <a href="/battery-configurator/">battery configurator page</a>.</p>

            <div class="line"></div>

            <button id="addButton" type="button" class="btn btn-outline-primary" onclick="add_cell()">
                <i class="fas fa-plus"></i><span class="px-2">Add a cell</span>
            </button>
            <form id="formEdit">
                <table id="table-cells"></table>
            </form>
        </div>
    </div>

    <!-- Modal confirm Delete-->
    <div class="modal fade" id="modalConfirmDelete" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteTitle">Delete</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the cell <b><span id="cellToDelete"></span></b>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="delete_confirm()">Delete cell</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal confirm Datasheet Delete-->
    <div class="modal fade" id="modalConfirmDatasheetDelete" tabindex="-1" role="dialog" aria-labelledby="confirmDatasheetDeleteTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDatasheetDeleteTitle">Delete</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the associated datasheet ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancel_delete_datasheet()">No, I changed my mind</button>
                    <button type="button" class="btn btn-danger" onclick="delete_datasheet()">Yes, I am sure</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal choose Datasheet-->
    <div class="modal fade" id="modalChooseDatasheet" tabindex="-1" role="dialog" aria-labelledby="chooseDatasheetTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chooseDatasheetTitle">Choose datasheet</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="formChooseDatasheet">
                    <div class="modal-body">
                        Please select a new datasheet for this cell :
                        <input type="file" class="form-control-file" id="inputAddDatasheet" accept=".pdf" name="Data-sheet" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="cancel_choose_datasheet()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add datasheet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal still Editing-->
    <div class="modal fade" id="modalStillEditing" tabindex="-1" role="dialog" aria-labelledby="stillEditingTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stillEditingTitle">Still Editing!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Please finish editing the current row before editing another one.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Ok</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal add Cell -->
    <div class="modal fade" id="modalAddCell" tabindex="-1" role="dialog" aria-labelledby="addCellTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCellTitle">Add a new cell</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="formAdd" method="POST" enctype="multipart/form-data">
                    <input name="Type" type="hidden" value="add">
                    <div class="modal-body">
                        <div class="form-group row">
                            <label for="inputName" class="col-sm-3 col-form-label">Name</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="inputName" placeholder="Cell name" required name="Name">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="inputVoltage" class="col-sm-3 col-form-label">Voltages </label>
                            <div class="col-sm-9 input-group">
                                <div class="col input-group p-0">
                                    <input type="number" step="0.1" min="0.1" class="form-control" id="inputVoltageMin" placeholder="Min" required name="Voltage Min">
                                    <div class="input-group-append">
                                        <span class="input-group-text">V</span>
                                    </div>
                                </div>
                                <div class="col input-group">
                                    <input type="number" step="0.1" min="0.1" class="form-control" id="inputVoltageNom" placeholder="Nom" required name="Voltage Nom">
                                    <div class="input-group-append">
                                        <span class="input-group-text">V</span>
                                    </div>
                                </div>
                                <div class="col input-group p-0">
                                    <input type="number" step="0.1" min="0.1" class="form-control" id="inputVoltageMax" placeholder="Max" required name="Voltage Max">
                                    <div class="input-group-append">
                                        <span class="input-group-text">V</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="inputEnergy" class="col-sm-3 col-form-label">Energy</label>
                            <div class="col-sm-9 input-group">
                                <input type="number" step="0.01" min="0.01" class="form-control" id="inputEnergy" placeholder="15.30" required name="Energy">
                                <div class="input-group-append">
                                    <span class="input-group-text">Wh</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="inputCapacity" class="col-sm-3 col-form-label">Capacity</label>
                            <div class="col-sm-9 input-group">
                                <input type="number" step="0.1" min="0.1" class="form-control" id="inputCapacity" placeholder="4.3" required name="Capacity">
                                <div class="input-group-append">
                                    <span class="input-group-text">Ah</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="inputMaxCurrent" class="col-sm-3 col-form-label">Max Current</label>
                            <div class="col-sm-9 input-group">
                                <input type="number" step="0.1" min="1" class="form-control" id="inputMaxCurrent" placeholder="15" required name="Max Current">
                                <div class="input-group-append">
                                    <span class="input-group-text">A</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="inputWeight" class="col-sm-3 col-form-label">Weight</label>
                            <div class="col-sm-9 input-group">
                                <input type="number" step="0.1" min="1" class="form-control" id="inputWeight" placeholder="63" required name="Weight">
                                <div class="input-group-append">
                                    <span class="input-group-text">g</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="inputPrice" class="col-sm-3 col-form-label">Price</label>
                            <div class="col-sm-9 input-group">
                                <input type="number" step="0.01" min="0.01" class="form-control" id="inputPrice" placeholder="4.25" required name="Price">
                                <select class="form-control" id="inputCurrency" name="Currency">
                                    <option>€</option>
                                    <option>$</option>
                                    <option>£</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="inputDatasheet" class="col-sm-3 col-form-label">Data-sheet</label>
                            <div class="col-sm-9 input-group">
                                <div class="col-sm-9">
                                    <input type="file" class="form-control-file" id="inputDatasheet" accept=".pdf" name="Data-sheet">
                                </div>
                                <div class="col-sm-3">
                                    <button type="button" class="btn btn-secondary" style="float:right;" onclick="$('#inputDatasheet')[0].value = '';"><i class="fas fa-undo"></i></button>
                                </div>
                            </div>
                        </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add cell</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- jQuery  -->
    <script src="/static/js/jquery-3.4.1.js"></script>

   <!-- Translation script -->
    <script src="/static/js/translation.js"></script>

    <!-- Include script -->
    <script src="/static/js/include.js"></script>

    <!-- Popper and Bootstrap script bundle -->
    <script src="/static/js/bootstrap.bundle.js"></script>


    <!-- Bootstrap Table -->
    <script src="/static/bootstrap-table/bootstrap-table.js"></script>
    <script src="/static/bootstrap-table/extensions/sticky-header/bootstrap-table-sticky-header.js"></script>
    <script src="/static/bootstrap-table/extensions/fixed-columns/bootstrap-table-fixed-columns.js"></script>

    <script type="application/javascript">

        // So the user does not change several lines at the same time
        var is_editing = false;
          
        var delete_confirmed = false;

        // To remember the initial state
        var initial_name        = "";
        var initial_voltage_min = "";
        var initial_voltage_nom = "";
        var initial_voltage_max = "";
        var initial_energy      = "";
        var initial_capacity    = "";
        var initial_max_current = "";
        var initial_weight      = "";
        var initial_price       = "";
        var initial_datasheet   = "";
        var initial_manage      = "";

        var update_datasheet = "";

        // Bootstrap's default behaviour is to delete the alert
        function dismiss_alert(button) {
            $(button.parentNode).hide();
        }

        // To clean all alerts before new action
        function hide_all_alerts() {
            $('#alertSuccessAdded').hide();
            $('#alertAlreadyExisting').hide();
            $('#alertDatasheet').hide();
            $('#alertSuccessDeleted').hide();
            $('#alertErrorDeleted').hide();
            $('#alertSuccessUpdated').hide();
            $('#alertErrorUpdated').hide();
        }

        function ajax_success(response) {

            let status = response[response.length - 1]['Status'];

            response.pop();

            switch (status) {
                case 'successAdded':
                    $('#alertSuccessAdded').show();
                    break;
                case 'alreadyExisting':
                    $('#alertAlreadyExisting').show();
                    break;
                case 'datasheet':
                    $('#alertDatasheet').show();
                    break;
                case 'successDeleted':
                    $('#alertSuccessDeleted').show();
                    break;
                case 'errorDeleted':
                    $('#alertErrorDeleted').show();
                    break;
                case 'successUpdated':
                    $('#alertSuccessUpdated').show();
                    break;
                case 'errorUpdated':
                    $('#alertErrorUpdated').show();
                    break;
                default:
                    break;
            }

            table_from_json(response);
        }
        
        function ajax_error() {
            $('#alertAjaxError').fadeIn();
        }
        
        function add_cell() {
            if(is_editing) {
                $('#modalStillEditing').modal('show');
            }

            else {
                $('#modalAddCell').modal('show');
            }
        }
    
        $("#formAdd").submit(function(event){

            event.preventDefault();
            hide_all_alerts();
            
            let formData = new FormData(this);
            
            $('#modalAddCell').modal('hide');
            
            $.ajax({
                type:           "POST",
                url:            '/cell-inventory/',
                data :          formData,
                processData:    false,
                contentType:     false,
                success:        ajax_success,
                error:          ajax_error,
                dataType:       'json'
            });
        });
        
        function delete_confirm() {
            delete_confirmed = true;
            $('#modalConfirmDelete').modal('hide');
        }
        
        function delete_row(button_clicked) {

            if(is_editing) {
                $('#modalStillEditing').modal('show');
            }

            else {
                hide_all_alerts();
                let row = button_clicked.parentNode.parentNode;
                let cellName = $(row).children()[0].innerHTML
                document.getElementById("cellToDelete").innerHTML = cellName;
                delete_confirmed = false;
                $('#modalConfirmDelete').modal('show');
                $('#modalConfirmDelete').on('hidden.bs.modal', function () {
                                        
                    if (delete_confirmed) {
                        $.ajax({
                            type:           "POST",
                            url:            '/cell-inventory/',
                            data :          'Type=delete&Name=' + cellName,
                            success:        ajax_success,
                            error:          ajax_error,
                            dataType:       'json'
                        });
                    }
                });
            }
        }
        
        $("#formEdit").submit(function(event){
            
            event.preventDefault();
            hide_all_alerts();
                
            let formData = new FormData();
            formData.append('Type', 'edit');
            formData.append('InitialName', initial_name);
            formData.append('Name', document.getElementById("editName").value);
            formData.append('Voltage Min', document.getElementById("editVoltageMin").value)
            formData.append('Voltage Nom', document.getElementById("editVoltageNom").value)
            formData.append('Voltage Max', document.getElementById("editVoltageMax").value)
            formData.append('Energy', document.getElementById("editEnergy").value)
            formData.append('Capacity', document.getElementById("editCapacity").value)
            formData.append('Max Current', document.getElementById("editMaxCurrent").value)
            formData.append('Weight', document.getElementById("editWeight").value)
            formData.append('Price', document.getElementById("editPrice").value)
            formData.append('Currency', document.getElementById("editCurrency").value)
            
            formData.append('DatasheetAction', update_datasheet)
            formData.append('HadDatasheet', (initial_datasheet == '') ? false : true)
            
            if ($('#inputAddDatasheet')[0].value != '') {
                formData.append('Data-sheet', $('#inputAddDatasheet')[0].files[0], $('#inputAddDatasheet')[0].value)
            }
            
            $.ajax({
                type:           "POST",
                url:            '/cell-inventory/',
                data :          formData,
                processData:    false,
                contentType:     false,
                success:        ajax_success,
                error:          ajax_error,
                dataType:       'json'
            });
        });    

        function delete_datasheet() {
            $('#editDelete').addClass('active');
            $('#editAdd').removeClass('active');
            $('#modalConfirmDatasheetDelete').modal('hide');
            update_datasheet = "delete";
            console.log(update_datasheet);
        }
        
        function cancel_delete_datasheet() {
            update_datasheet = (update_datasheet == "add") ? "add" : "none";
            $('#editDelete').removeClass('active');
            $('#modalConfirmDatasheetDelete').modal('hide');
            console.log(update_datasheet);
        }
        
        $("#formChooseDatasheet").submit(function(event){

            event.preventDefault();
            choose_datasheet();
        });
        
        function choose_datasheet() {
            $('#editAdd').addClass('active');
            $('#editDelete').removeClass('active');
            $('#modalChooseDatasheet').modal('hide');
            update_datasheet = "add";
            console.log(update_datasheet);
        }
        
        function cancel_choose_datasheet() {
            update_datasheet = (update_datasheet == "delete") ? "delete" : "none";
            $('#editAdd').removeClass('active');
            $('#modalChooseDatasheet').modal('hide');
            console.log(update_datasheet);
        }
        
        // When the "edit" button is clicked
        function edit_row(button_clicked) {

            if(is_editing) {
                $('#modalStillEditing').modal('show');
                return 1;
            }

            // Getting the row of the button called
            let row = button_clicked.parentNode.parentNode;

            initial_name        = $(row).children()[0].innerHTML;
            initial_voltage_min = $(row).children()[1].innerHTML;
            initial_voltage_nom = $(row).children()[2].innerHTML;
            initial_voltage_max = $(row).children()[3].innerHTML;
            initial_energy      = $(row).children()[4].innerHTML;
            initial_capacity    = $(row).children()[5].innerHTML;
            initial_max_current = $(row).children()[6].innerHTML;
            initial_weight      = $(row).children()[7].innerHTML;
            initial_price       = $(row).children()[8].innerHTML;
            initial_datasheet   = $(row).children()[9].innerHTML;
            initial_manage      = $(row).children()[10].innerHTML;

            is_editing = true;
            update_datasheet = "none";
            $('#inputAddDatasheet')[0].value = '';
            
            $(row).children()[0].innerHTML = `<input type="text" id="editName" class="form-control form-control-sm" value="${initial_name}" required>`;

            $(row).children()[1].innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="number" step="0.1" min="0.1" id="editVoltageMin" class="form-control no-spin" value="${initial_voltage_min.slice(0, -1)}" required>
                    <div class="input-group-append">
                        <span class="input-group-text">V</span>
                    </div>
                </div>`;
            $(row).children()[2].innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="number" step="0.1" min="0.1" id="editVoltageNom" class="form-control no-spin" value="${initial_voltage_nom.slice(0, -1)}" required>
                    <div class="input-group-append">
                        <span class="input-group-text">V</span>
                    </div>
                </div>`;
            $(row).children()[3].innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="number" step="0.1" min="0.1" id="editVoltageMax" class="form-control no-spin" value="${initial_voltage_max.slice(0, -1)}" required>
                    <div class="input-group-append">
                        <span class="input-group-text">V</span>
                    </div>
                </div>`;

            $(row).children()[4].innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="number" step="0.01" min="0.01" id="editEnergy" class="form-control no-spin" value="${initial_energy.slice(0, -2)}" required>
                    <div class="input-group-append">
                        <span class="input-group-text">Wh</span>
                    </div>
                </div>`;

            $(row).children()[5].innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="number" step="0.1" min="0.1" id="editCapacity" class="form-control no-spin" value="${initial_capacity.slice(0, -2)}" required>
                    <div class="input-group-append">
                        <span class="input-group-text">Ah</span>
                    </div>
                </div>`;

            $(row).children()[6].innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="number" step="0.1" min="1" id="editMaxCurrent" class="form-control no-spin" value="${initial_max_current.slice(0, -1)}" required>
                    <div class="input-group-append">
                        <span class="input-group-text">A</span>
                    </div>
                </div>`;

            $(row).children()[7].innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="number" step="0.1" min="1" id="editWeight" class="form-control no-spin" value="${initial_weight.slice(0, -1)}" required>
                    <div class="input-group-append">
                        <span class="input-group-text">g</span>
                    </div>
                </div>`;

            $(row).children()[8].innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="number" step="0.01" min="0.01" id="editPrice" class="form-control no-spin" value="${initial_price.slice(0, -1)}" required>
                    <select class="form-control form-control-sm" id="editCurrency" value="£">
                        <option>€</option>
                        <option>$</option>
                        <option>£</option>
                    </select>
                </div>`;
                
            document.getElementById('editCurrency').value = initial_price.slice(-1, initial_price.length);
            
            if ($(row).children()[9].innerHTML == '') {
                $(row).children()[9].innerHTML = `<button type="button" id="editAdd" class="btn btn-outline-primary btn-sm" onclick="$('#modalChooseDatasheet').modal('show');"><i class="fas fa-plus"></i></button>`
            }
            else {
                $(row).children()[9].innerHTML = `<button type="button" id="editDelete" class="btn btn-outline-danger btn-sm" onclick="$('#modalConfirmDatasheetDelete').modal('show');"><i class="fas fa-trash-alt"></i></button>
                <button type="button" id="editAdd" class="btn btn-outline-primary btn-sm" onclick="$('#modalChooseDatasheet').modal('show');"><i class="fas fa-exchange-alt"></i></button>`
            }
            
             $(row).children()[10].innerHTML = `<button type="button" class="btn btn-outline-danger btn-sm" onclick="discard(this)"><i class="fas fa-ban"></i></button>
                                              <button type="submit" class="btn btn-outline-success btn-sm"><i class="fas fa-check"></i></button>`;
        }
        
        function confirm_edit(button_clicked){
        
        }

        function discard(button_clicked) {
            let row = button_clicked.parentNode.parentNode;

            $(row).children()[0].innerHTML = initial_name;
            $(row).children()[1].innerHTML = initial_voltage_min;
            $(row).children()[2].innerHTML = initial_voltage_nom;
            $(row).children()[3].innerHTML = initial_voltage_max;
            $(row).children()[4].innerHTML = initial_energy;
            $(row).children()[5].innerHTML = initial_capacity;
            $(row).children()[6].innerHTML = initial_max_current;
            $(row).children()[7].innerHTML = initial_weight;
            $(row).children()[8].innerHTML = initial_price;
            $(row).children()[9].innerHTML = initial_datasheet;
            $(row).children()[10].innerHTML = initial_manage;

            is_editing = false;
        }


        function add_units(row) {
            row["Voltage Min"] += "V";
            row["Voltage Nom"] += "V";
            row["Voltage Max"] += "V";
            row["Energy"] += "Wh";
            row["Capacity"] += "Ah";
            row["Max Current"] += "A";
            row["Weight"] += "g";

            return row;
        }
        
                
        function get_datasheet(button_clicked) {
            
            let row = button_clicked.parentNode.parentNode;
            let cell_name = $(row).children()[0].innerHTML;
            
            var oReq = new XMLHttpRequest();
            oReq.open('GET', '/cell-inventory/?Type=get_datasheet&Name=' + cell_name, true);
            oReq.responseType = 'arraybuffer';
            
            oReq.onload = function (oEvent) {
                
                let arrayBuffer = oReq.response;
                blob = new Blob([arrayBuffer], {type: 'application/pdf'});
                
                let url = window.URL.createObjectURL(blob);
    
                let a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = cell_name + '.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            };
            
            oReq.send(null);
                        
        }
        
        function table_from_json(json_cells) {
            is_editing = false;
            Object.keys(json_cells).forEach(function(key) {

                json_cells[key] = add_units(json_cells[key]);

                json_cells[key]["Price"] = json_cells[key]["Price"] + json_cells[key]["Currency"];

                if(json_cells[key]["Data-sheet"]===true) {
                    json_cells[key]["Data-sheet"] = `<button type="button" class="btn btn-secondary btn-sm" onclick="get_datasheet(this)"><i class="fas fa-file-alt"></i></button>`;
                }
                
                else {
                    json_cells[key]["Data-sheet"] = "";
                }

                json_cells[key]["Manage"] = `<button type="button" class="btn btn-outline-primary btn-sm hover-only" onclick="edit_row(this)"><i class="fas fa-edit"></i></button>
                                             <button type="button" class="btn btn-outline-danger btn-sm hover-only" onclick="delete_row(this)"><i class="fas fa-trash-alt"></i></button>`;

            })

            

            $('#table-cells').bootstrapTable("load", json_cells);

        }
        
        
        $(document).ready(function() {
            
            $('#table-cells').bootstrapTable({
                classes: 'table table-hover',
                stickyHeader: true,
                sortName: "Name",
                sortOrder: "asc",
                fixedColumns: true,
                fixedNumber: 1,
                columns: [[{
                        field: 'Name',
                        title: 'Name',
                        rowspan: 2,
                        sortable: true
                    }, {
                        title: 'Voltage',
                        colspan: 3,
                    }, {
                        field: 'Energy',
                        title: 'Energy',
                        rowspan: 2,
                        sortable: true
                    }, {
                        field: 'Capacity',
                        title: 'Capacity',
                        rowspan: 2,
                        sortable: true
                    }, {
                        field: 'Max Current',
                        title: 'Max Current',
                        sortable: true,
                        width: 8,
                        rowspan: 2,
                        widthUnit: "rem"
                    }, {
                        field: 'Weight',
                        title: 'Weight',
                        rowspan: 2,
                        sortable: true
                    }, {
                        field: 'Price',
                        title: 'Price',
                        rowspan: 2,
                        sortable: true
                    }, {
                        field: 'Data-sheet',
                        title: 'Data-sheet',
                        sortable: true,
                        rowspan: 2,
                        width: 6,
                        widthUnit: 'rem'
                    }, {
                        field: 'Manage',
                        title: 'Manage',
                        rowspan: 2,
                        width: 6,
                        widthUnit: 'rem'
                    }],[{
                        field: 'Voltage Min',
                        title: 'Min',
                        sortable: true,
                    }, {
                        field: 'Voltage Nom',
                        title: 'Nom',
                        sortable: true
                    }, {
                        field: 'Voltage Max',
                        title: 'Max',
                        sortable: true
                    }]]
            });
            
            $.ajax({
                type:           "POST",
                url:            '/cell-inventory/',
                data :          'Type=get_cells',
                success:        ajax_success,
                error:          ajax_error,
                dataType:       'json'
            });

        });
        

        
    </script>



</body>

</html>
